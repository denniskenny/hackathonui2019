{"filter":false,"title":"nested-cloudformation-stack.yml","tooltip":"/profile/amplify/backend/awscloudformation/nested-cloudformation-stack.yml","undoManager":{"mark":2,"position":2,"stack":[[{"start":{"row":79,"column":0},"end":{"row":297,"column":0},"action":"insert","lines":["\t\t},","\t\t\"authprofilefe7d64d0\": {","\t\t\t\"Type\": \"AWS::CloudFormation::Stack\",","\t\t\t\"Properties\": {","\t\t\t\t\"TemplateURL\": \"https://s3.amazonaws.com/amplify-profile-hackathon-113549-deployment/amplify-cfn-templates/auth/profilefe7d64d0-cloudformation-template.yml\",","\t\t\t\t\"Parameters\": {","\t\t\t\t\t\"identityPoolName\": \"profilefe7d64d0_identitypool_fe7d64d0\",","\t\t\t\t\t\"allowUnauthenticatedIdentities\": false,","\t\t\t\t\t\"resourceNameTruncated\": \"profilfe7d64d0\",","\t\t\t\t\t\"userPoolName\": \"profilefe7d64d0_userpool_fe7d64d0\",","\t\t\t\t\t\"autoVerifiedAttributes\": \"email\",","\t\t\t\t\t\"mfaConfiguration\": \"OFF\",","\t\t\t\t\t\"mfaTypes\": \"SMS Text Message\",","\t\t\t\t\t\"smsAuthenticationMessage\": \"Your authentication code is {####}\",","\t\t\t\t\t\"smsVerificationMessage\": \"Your verification code is {####}\",","\t\t\t\t\t\"emailVerificationSubject\": \"Your verification code\",","\t\t\t\t\t\"emailVerificationMessage\": \"Your verification code is {####}\",","\t\t\t\t\t\"defaultPasswordPolicy\": false,","\t\t\t\t\t\"passwordPolicyMinLength\": 8,","\t\t\t\t\t\"passwordPolicyCharacters\": \"\",","\t\t\t\t\t\"requiredAttributes\": \"email\",","\t\t\t\t\t\"userpoolClientGenerateSecret\": true,","\t\t\t\t\t\"userpoolClientRefreshTokenValidity\": 30,","\t\t\t\t\t\"userpoolClientWriteAttributes\": \"email\",","\t\t\t\t\t\"userpoolClientReadAttributes\": \"email\",","\t\t\t\t\t\"userpoolClientLambdaRole\": \"profilfe7d64d0_userpoolclient_lambda_role\",","\t\t\t\t\t\"userpoolClientSetAttributes\": false,","\t\t\t\t\t\"resourceName\": \"profilefe7d64d0\",","\t\t\t\t\t\"authSelections\": \"identityPoolAndUserPool\",","\t\t\t\t\t\"authRoleArn\": {","\t\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\t\"AuthRole\",","\t\t\t\t\t\t\t\"Arn\"","\t\t\t\t\t\t]","\t\t\t\t\t},","\t\t\t\t\t\"unauthRoleArn\": {","\t\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\t\"UnauthRole\",","\t\t\t\t\t\t\t\"Arn\"","\t\t\t\t\t\t]","\t\t\t\t\t},","\t\t\t\t\t\"useDefault\": \"default\",","\t\t\t\t\t\"usernameAttributes\": \"email\",","\t\t\t\t\t\"userPoolGroupList\": \"\",","\t\t\t\t\t\"dependsOn\": \"\",","\t\t\t\t\t\"env\": \"hackathon\"","\t\t\t\t}","\t\t\t}","\t\t},","\t\t\"UpdateRolesWithIDPFunction\": {","\t\t\t\"DependsOn\": [","\t\t\t\t\"AuthRole\",","\t\t\t\t\"UnauthRole\",","\t\t\t\t\"authprofilefe7d64d0\"","\t\t\t],","\t\t\t\"Type\": \"AWS::Lambda::Function\",","\t\t\t\"Properties\": {","\t\t\t\t\"Code\": {","\t\t\t\t\t\"ZipFile\": {","\t\t\t\t\t\t\"Fn::Join\": [","\t\t\t\t\t\t\t\"\\n\",","\t\t\t\t\t\t\t[","\t\t\t\t\t\t\t\t\"const response = require('cfn-response');\",","\t\t\t\t\t\t\t\t\"const aws = require('aws-sdk');\",","\t\t\t\t\t\t\t\t\"let responseData = {};\",","\t\t\t\t\t\t\t\t\"exports.handler = function(event, context) {\",","\t\t\t\t\t\t\t\t\"  try {\",","\t\t\t\t\t\t\t\t\"    let authRoleName = event.ResourceProperties.authRoleName;\",","\t\t\t\t\t\t\t\t\"    let unauthRoleName = event.ResourceProperties.unauthRoleName;\",","\t\t\t\t\t\t\t\t\"    let idpId = event.ResourceProperties.idpId;\",","\t\t\t\t\t\t\t\t\"    let promises = [];\",","\t\t\t\t\t\t\t\t\"    let authParamsJson = { 'Version': '2012-10-17','Statement': [{'Effect': 'Allow','Principal': {'Federated': 'cognito-identity.amazonaws.com'},'Action': 'sts:AssumeRoleWithWebIdentity','Condition': {'StringEquals': {'cognito-identity.amazonaws.com:aud': idpId},'ForAnyValue:StringLike': {'cognito-identity.amazonaws.com:amr': 'authenticated'}}}]};\",","\t\t\t\t\t\t\t\t\"    let unauthParamsJson = { 'Version': '2012-10-17','Statement': [{'Effect': 'Allow','Principal': {'Federated': 'cognito-identity.amazonaws.com'},'Action': 'sts:AssumeRoleWithWebIdentity','Condition': {'StringEquals': {'cognito-identity.amazonaws.com:aud': idpId},'ForAnyValue:StringLike': {'cognito-identity.amazonaws.com:amr': 'unauthenticated'}}}]};\",","\t\t\t\t\t\t\t\t\"    if (event.RequestType == 'Delete') {\",","\t\t\t\t\t\t\t\t\"        delete authParamsJson.Statement.Condition;\",","\t\t\t\t\t\t\t\t\"        delete unauthParamsJson.Statement.Condition;\",","\t\t\t\t\t\t\t\t\"        let authParams = { PolicyDocument: JSON.stringify(authParamsJson),RoleName: authRoleName};\",","\t\t\t\t\t\t\t\t\"        let unauthParams = {PolicyDocument: JSON.stringify(unauthParamsJson),RoleName: unauthRoleName};\",","\t\t\t\t\t\t\t\t\"        const iam = new aws.IAM({ apiVersion: '2010-05-08', region: event.ResourceProperties.region});\",","\t\t\t\t\t\t\t\t\"        promises.push(iam.updateAssumeRolePolicy(authParams).promise());\",","\t\t\t\t\t\t\t\t\"        promises.push(iam.updateAssumeRolePolicy(unauthParams).promise());\",","\t\t\t\t\t\t\t\t\"        Promise.all(promises)\",","\t\t\t\t\t\t\t\t\"         .then((res) => {\",","\t\t\t\t\t\t\t\t\"            console.log(\\\"delete response data\\\" + JSON.stringify(res));\",","\t\t\t\t\t\t\t\t\"            response.send(event, context, response.SUCCESS, {});\",","\t\t\t\t\t\t\t\t\"         });\",","\t\t\t\t\t\t\t\t\"    }\",","\t\t\t\t\t\t\t\t\"    if (event.RequestType == 'Update' || event.RequestType == 'Create') {\",","\t\t\t\t\t\t\t\t\"       const iam = new aws.IAM({ apiVersion: '2010-05-08', region: event.ResourceProperties.region});\",","\t\t\t\t\t\t\t\t\"        let authParams = { PolicyDocument: JSON.stringify(authParamsJson),RoleName: authRoleName};\",","\t\t\t\t\t\t\t\t\"        let unauthParams = {PolicyDocument: JSON.stringify(unauthParamsJson),RoleName: unauthRoleName};\",","\t\t\t\t\t\t\t\t\"        promises.push(iam.updateAssumeRolePolicy(authParams).promise());\",","\t\t\t\t\t\t\t\t\"        promises.push(iam.updateAssumeRolePolicy(unauthParams).promise());\",","\t\t\t\t\t\t\t\t\"        Promise.all(promises)\",","\t\t\t\t\t\t\t\t\"         .then((res) => {\",","\t\t\t\t\t\t\t\t\"            console.log(\\\"createORupdate\\\" + res);\",","\t\t\t\t\t\t\t\t\"            console.log(\\\"response data\\\" + JSON.stringify(res));\",","\t\t\t\t\t\t\t\t\"            response.send(event, context, response.SUCCESS, {});\",","\t\t\t\t\t\t\t\t\"         });\",","\t\t\t\t\t\t\t\t\"    }\",","\t\t\t\t\t\t\t\t\"  } catch(err) {\",","\t\t\t\t\t\t\t\t\"       console.log(err.stack);\",","\t\t\t\t\t\t\t\t\"       responseData = {Error: err};\",","\t\t\t\t\t\t\t\t\"       response.send(event, context, response.FAILED, responseData);\",","\t\t\t\t\t\t\t\t\"       throw err;\",","\t\t\t\t\t\t\t\t\"  }\",","\t\t\t\t\t\t\t\t\"};\"","\t\t\t\t\t\t\t]","\t\t\t\t\t\t]","\t\t\t\t\t}","\t\t\t\t},","\t\t\t\t\"Handler\": \"index.handler\",","\t\t\t\t\"Runtime\": \"nodejs8.10\",","\t\t\t\t\"Timeout\": \"300\",","\t\t\t\t\"Role\": {","\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\"UpdateRolesWithIDPFunctionRole\",","\t\t\t\t\t\t\"Arn\"","\t\t\t\t\t]","\t\t\t\t}","\t\t\t}","\t\t},","\t\t\"UpdateRolesWithIDPFunctionOutputs\": {","\t\t\t\"Type\": \"Custom::LambdaCallout\",","\t\t\t\"Properties\": {","\t\t\t\t\"ServiceToken\": {","\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\"UpdateRolesWithIDPFunction\",","\t\t\t\t\t\t\"Arn\"","\t\t\t\t\t]","\t\t\t\t},","\t\t\t\t\"region\": {","\t\t\t\t\t\"Ref\": \"AWS::Region\"","\t\t\t\t},","\t\t\t\t\"idpId\": {","\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\"authprofilefe7d64d0\",","\t\t\t\t\t\t\"Outputs.IdentityPoolId\"","\t\t\t\t\t]","\t\t\t\t},","\t\t\t\t\"authRoleName\": {","\t\t\t\t\t\"Ref\": \"AuthRoleName\"","\t\t\t\t},","\t\t\t\t\"unauthRoleName\": {","\t\t\t\t\t\"Ref\": \"UnauthRoleName\"","\t\t\t\t}","\t\t\t}","\t\t},","\t\t\"UpdateRolesWithIDPFunctionRole\": {","\t\t\t\"Type\": \"AWS::IAM::Role\",","\t\t\t\"Properties\": {","\t\t\t\t\"RoleName\": {","\t\t\t\t\t\"Fn::Join\": [","\t\t\t\t\t\t\"\",","\t\t\t\t\t\t[","\t\t\t\t\t\t\t{","\t\t\t\t\t\t\t\t\"Ref\": \"AuthRoleName\"","\t\t\t\t\t\t\t},","\t\t\t\t\t\t\t\"-idp\"","\t\t\t\t\t\t]","\t\t\t\t\t]","\t\t\t\t},","\t\t\t\t\"AssumeRolePolicyDocument\": {","\t\t\t\t\t\"Version\": \"2012-10-17\",","\t\t\t\t\t\"Statement\": [","\t\t\t\t\t\t{","\t\t\t\t\t\t\t\"Effect\": \"Allow\",","\t\t\t\t\t\t\t\"Principal\": {","\t\t\t\t\t\t\t\t\"Service\": [","\t\t\t\t\t\t\t\t\t\"lambda.amazonaws.com\"","\t\t\t\t\t\t\t\t]","\t\t\t\t\t\t\t},","\t\t\t\t\t\t\t\"Action\": [","\t\t\t\t\t\t\t\t\"sts:AssumeRole\"","\t\t\t\t\t\t\t]","\t\t\t\t\t\t}","\t\t\t\t\t]","\t\t\t\t},","\t\t\t\t\"Policies\": [","\t\t\t\t\t{","\t\t\t\t\t\t\"PolicyName\": \"UpdateRolesWithIDPFunctionPolicy\",","\t\t\t\t\t\t\"PolicyDocument\": {","\t\t\t\t\t\t\t\"Version\": \"2012-10-17\",","\t\t\t\t\t\t\t\"Statement\": [","\t\t\t\t\t\t\t\t{","\t\t\t\t\t\t\t\t\t\"Effect\": \"Allow\",","\t\t\t\t\t\t\t\t\t\"Action\": [","\t\t\t\t\t\t\t\t\t\t\"logs:CreateLogGroup\",","\t\t\t\t\t\t\t\t\t\t\"logs:CreateLogStream\",","\t\t\t\t\t\t\t\t\t\t\"logs:PutLogEvents\"","\t\t\t\t\t\t\t\t\t],","\t\t\t\t\t\t\t\t\t\"Resource\": \"arn:aws:logs:*:*:*\"","\t\t\t\t\t\t\t\t},","\t\t\t\t\t\t\t\t{","\t\t\t\t\t\t\t\t\t\"Effect\": \"Allow\",","\t\t\t\t\t\t\t\t\t\"Action\": \"iam:UpdateAssumeRolePolicy\",","\t\t\t\t\t\t\t\t\t\"Resource\": {","\t\t\t\t\t\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\t\t\t\t\t\"AuthRole\",","\t\t\t\t\t\t\t\t\t\t\t\"Arn\"","\t\t\t\t\t\t\t\t\t\t]","\t\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t\t},","\t\t\t\t\t\t\t\t{","\t\t\t\t\t\t\t\t\t\"Effect\": \"Allow\",","\t\t\t\t\t\t\t\t\t\"Action\": \"iam:UpdateAssumeRolePolicy\",","\t\t\t\t\t\t\t\t\t\"Resource\": {","\t\t\t\t\t\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\t\t\t\t\t\"UnauthRole\",","\t\t\t\t\t\t\t\t\t\t\t\"Arn\"","\t\t\t\t\t\t\t\t\t\t]","\t\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t]","\t\t\t\t\t\t}","\t\t\t\t\t}","\t\t\t\t]","\t\t\t}",""],"id":2,"ignore":true}],[{"start":{"row":86,"column":39},"end":{"row":86,"column":43},"action":"remove","lines":["fals"],"id":3,"ignore":true},{"start":{"row":86,"column":39},"end":{"row":86,"column":42},"action":"insert","lines":["tru"]},{"start":{"row":128,"column":0},"end":{"row":155,"column":0},"action":"insert","lines":["\t\t\"analyticsprofile\": {","\t\t\t\"Type\": \"AWS::CloudFormation::Stack\",","\t\t\t\"Properties\": {","\t\t\t\t\"TemplateURL\": \"https://s3.amazonaws.com/amplify-profile-hackathon-113549-deployment/amplify-cfn-templates/analytics/pinpoint-cloudformation-template.json\",","\t\t\t\t\"Parameters\": {","\t\t\t\t\t\"appName\": \"profile\",","\t\t\t\t\t\"roleName\": \"pinpointLambdaRolebf78f189\",","\t\t\t\t\t\"cloudWatchPolicyName\": \"cloudWatchPolicybf78f189\",","\t\t\t\t\t\"pinpointPolicyName\": \"pinpointPolicybf78f189\",","\t\t\t\t\t\"authPolicyName\": \"pinpoint_amplify_bf78f189\",","\t\t\t\t\t\"unauthPolicyName\": \"pinpoint_amplify_bf78f189\",","\t\t\t\t\t\"authRoleName\": {","\t\t\t\t\t\t\"Ref\": \"AuthRoleName\"","\t\t\t\t\t},","\t\t\t\t\t\"unauthRoleName\": {","\t\t\t\t\t\t\"Ref\": \"UnauthRoleName\"","\t\t\t\t\t},","\t\t\t\t\t\"authRoleArn\": {","\t\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\t\"AuthRole\",","\t\t\t\t\t\t\t\"Arn\"","\t\t\t\t\t\t]","\t\t\t\t\t},","\t\t\t\t\t\"env\": \"hackathon\"","\t\t\t\t}","\t\t\t}","\t\t},",""]}],[{"start":{"row":155,"column":0},"end":{"row":176,"column":0},"action":"insert","lines":["\t\t\"apiprofile\": {","\t\t\t\"Type\": \"AWS::CloudFormation::Stack\",","\t\t\t\"Properties\": {","\t\t\t\t\"TemplateURL\": \"https://s3.amazonaws.com/amplify-profile-hackathon-113549-deployment/amplify-cfn-templates/api/cloudformation-template.json\",","\t\t\t\t\"Parameters\": {","\t\t\t\t\t\"CreateAPIKey\": 0,","\t\t\t\t\t\"AppSyncApiName\": \"profile\",","\t\t\t\t\t\"DynamoDBBillingMode\": \"PAY_PER_REQUEST\",","\t\t\t\t\t\"DynamoDBEnableServerSideEncryption\": \"false\",","\t\t\t\t\t\"AuthCognitoUserPoolId\": {","\t\t\t\t\t\t\"Fn::GetAtt\": [","\t\t\t\t\t\t\t\"authprofilefe7d64d0\",","\t\t\t\t\t\t\t\"Outputs.UserPoolId\"","\t\t\t\t\t\t]","\t\t\t\t\t},","\t\t\t\t\t\"S3DeploymentBucket\": \"amplify-profile-hackathon-113549-deployment\",","\t\t\t\t\t\"S3DeploymentRootKey\": \"amplify-appsync-files/02850a16eee170834fc021bb47e7aa20b2de7016\",","\t\t\t\t\t\"env\": \"hackathon\"","\t\t\t\t}","\t\t\t}","\t\t},",""],"id":4,"ignore":true}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":0,"column":0},"end":{"row":0,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1573648776027,"hash":"fdd6f0c017bddd65fc56e4927e9f3f9abe151317"}